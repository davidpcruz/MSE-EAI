<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.2"
	name="eai.msejdf.jbpm">
	
<!-- 
     ########################################################################################################## 
		Start Node
	 ########################################################################################################## 
-->	
	<start-state name="start">
		<event type="node-enter">
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action0" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Starting BPM</message>
			</action>
		</event>
		<transition to="TempInsertCompany" name="Check Stock Variation"></transition>
	</start-state> 

<!-- 
     ########################################################################################################## 
		TODO: Remove this TempInserCompany Node		
	 ########################################################################################################## 
-->
	<node name="TempInsertCompany">
		<transition to="Check Stock Variation">
			<action name="TempInsertCompany" class="eai.msejdf.jbpm.actions.TempInsertCompany"></action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		Check Stock Variation Node		
	 ########################################################################################################## 
-->
	<decision name="Check Stock Variation">
		<handler class="eai.msejdf.jbpm.actions.CheckStockVariationDecisionHandler"></handler>

		<transition to="Approve Stock Variation Notification" name="Request Approval">
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Request Approval</message>
			</action>
		</transition>

		<transition to="SetUsersWarnedAutomatically" name="Notify User">
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Notify user</message>
			</action>
		</transition>

		<transition to="GenerateReport" name="No Action Required">
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>No Action required</message>
			</action>
		</transition>
	</decision>

<!-- 
     ########################################################################################################## 
		Approve Stock Variation Notification Node
	 ########################################################################################################## 
-->
	<task-node name="Approve Stock Variation Notification">

		<task name="Approve stock variation e-mail notification">
			<assignment actor-id="Manager"></assignment>
		</task>

		<transition to="GenerateReport" name="Reject notification">

			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action2" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Notification Rejected</message>
			</action>
		</transition>

		<transition to="SetUsersWarnedByManager" name="Approve Notification">

			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action3" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Notification Approved</message>
			</action>
		</transition>
	</task-node>

<!-- 
     ########################################################################################################## 
		Identify Company Node
	 ########################################################################################################## 
-->
	<node name="Identify Company">
		<transition to="Get Subscribed Users">
			<action name="Extract Company Name"
				class="eai.msejdf.jbpm.actions.ExtractCompanyName">
			</action>	
		</transition>
	</node>
	
<!-- 
     ########################################################################################################## 
		Get Subscribed Users Node
	 ########################################################################################################## 
-->
	<node name="Get Subscribed Users">
		<action name="GetUsersFollowingCompany"
			class="org.jboss.soa.esb.services.jbpm.actionhandlers.EsbActionHandler">
			<esbCategoryName>
				EAI_ESB
			</esbCategoryName>
			<esbServiceName>GetUsersFollowingCompany</esbServiceName>
			<bpmToEsbVars>
				<mapping bpm="msgBody" esb="BODY_CONTENT" />
				<mapping bpm="companyName" esb="companyName" />
			</bpmToEsbVars>
			<esbToBpmVars>
				<mapping esb="userList" bpm="userList"/>
			</esbToBpmVars>
		</action>		
		<transition to="Notify User">
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		Notify User Node
	 ########################################################################################################## 
-->
	<fork name="Notify User">
		<transition to="Send e-Mail" name="Start e-mail sending">
			<action name="esb Service Call - Prepare Mail Send"
				class="eai.msejdf.jbpm.actions.PrepareEsbMailSendCall">
			</action>		
		</transition>
		<transition to="Count e-Mail" name="Start e-mail counting">
			<action name="esb Service Call - Prepare Mail Count"
				class="eai.msejdf.jbpm.actions.PrepareEsbMailCountCall">
			</action>		
		</transition>
	</fork>

<!-- 
     ########################################################################################################## 
		Send e-Mail Node
	 ########################################################################################################## 
-->
	<node name="Send e-Mail">
<!-- 		<action name="esb Service Call - Send e-mail" -->
<!-- 			class="org.jboss.soa.esb.services.jbpm.actionhandlers.EsbActionHandler"> -->
<!-- 			<esbCategoryName> -->
<!-- 				EAI_ESB -->
<!-- 			</esbCategoryName> -->
<!-- 			<esbServiceName>Send e-mail</esbServiceName> -->
<!-- 			<bpmToEsbVars> -->
<!-- 				<mapping bpm="mailTo" esb="mailTo" /> -->
<!-- 				<mapping bpm="mailSubject" esb="mailSubject" />				 -->
<!-- 				<mapping bpm="mailMessage" esb="mailMessage" />				 -->
<!-- 				<mapping bpm="msgBody" esb="BODY_CONTENT"/> -->
<!-- 			</bpmToEsbVars> -->
<!-- 		</action> -->

		<transition to="Wait e-mail actions complete">
			<action name="esb Service Call - Send e-mail"
				class="org.jboss.soa.esb.services.jbpm.actionhandlers.EsbNotifier">
				<esbCategoryName>
					EAI_ESB
				</esbCategoryName>
				<esbServiceName>Send e-mail</esbServiceName>
				<bpmToEsbVars>
					<mapping bpm="mailTo" esb="mailTo" />
					<mapping bpm="mailSubject" esb="mailSubject" />				
					<mapping bpm="mailMessage" esb="mailMessage" />				
					<mapping bpm="msgBody" esb="BODY_CONTENT"/>
				</bpmToEsbVars>
			</action>
		
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action4" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Send e-mail complete</message>
			</action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		Count e-Mail Node
	 ########################################################################################################## 
-->
	<node name="Count e-Mail">
		<action name="esb Service Call - Count e-mail"
			class="org.jboss.soa.esb.services.jbpm.actionhandlers.EsbActionHandler"  async="true"> 
			<esbCategoryName>
				EAI_ESB
			</esbCategoryName>
			<esbServiceName>IncrementUserEmailCount</esbServiceName>
			<bpmToEsbVars>
				<mapping bpm="userIdList" esb="userIdList" />
			</bpmToEsbVars>
		</action>

		<transition to="Wait e-mail actions complete">
			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action4" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Count e-mail complete</message>
			</action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		Wait e-mail actions complete Node
	 ########################################################################################################## 
-->
	<join name="Wait e-mail actions complete">
		<transition to="GenerateReport">

			<!-- TODO: Remove this action (used for debugging) -->
			<action name="action4" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Waiting e-mail actions complete</message>
			</action>
		</transition>
	</join>

<!-- 
     ########################################################################################################## 
		SetUsersWarnedAutomatically Node
	 ########################################################################################################## 
-->
	<node name="SetUsersWarnedAutomatically">
		<transition to="Identify Company">
			<action name="SetUsersWarnedAutomatically" class="eai.msejdf.jbpm.actions.SetUsersWarnedAutomatically"></action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		SetUsersWarnedByManager Node
	 ########################################################################################################## 
-->
	<node name="SetUsersWarnedByManager">
		<transition to="Identify Company">
			<action name="SetUsersWarnedByManager" class="eai.msejdf.jbpm.actions.SetUsersWarnedByManager"></action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		Generate Report Node
	 ########################################################################################################## 
-->
	<node name="GenerateReport">
		<transition to="end-state2">
			<action name="GenerateReport" class="eai.msejdf.jbpm.actions.GenerateReport"></action>
		</transition>
	</node>

<!-- 
     ########################################################################################################## 
		End State Node
	 ########################################################################################################## 
-->
	<end-state name="end-state2">
		<!-- TODO: Remove this action and event (used for debugging) -->
		<event type="node-enter">
			<action name="action" class="eai.msejdf.jbpm.actions.MessageActionHandler">
				<message>Ended jBPM Orchestration Process</message>
			</action>
		</event>
	</end-state>

</process-definition>